@model Bazsoft_ERP.Models.Recojo
@{
    ViewBag.Title = "Recojo";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var Registrar = ViewBag.Registrar;
    var Editar = ViewBag.Editar;
    var Anular = ViewBag.Anular;
    var Imprimir = ViewBag.Imprimir;
    var Fecha = ViewBag.Fecha;
}
@section Styles {
    <link rel="stylesheet" href="~/adminlte/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="~/adminlte/plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
    <link rel="stylesheet" href="~/adminlte/plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
    <link href="~/adminlte/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css" rel="stylesheet" />
}

<section class="content-header">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0 text-secondary font-weight-bold">Listado de Recojos</h4>

            <div class="d-flex gap-2">                
                <button type="button" class="btn btn-outline-success btn-sm" onclick="nuevoRecojo()">
                    <i class="fas fa-plus"></i> Nuevo
                </button>               
            </div>
        </div>
    </div>
</section>

<section class="content">
    <div class="card card-outline card-secondary shadow-sm">
        <div class="card-header py-2">
            <h6 class="mb-0 text-muted">Filtros de búsqueda</h6>
        </div>
        <div class="card-body py-2">
            <form asp-controller="Procesos" asp-action="IndexRecojo" method="post" class="form-row align-items-end">

                <div class="form-group col-md-2 mb-2">
                    <label for="fecha" class="small font-weight-bold">Fecha Desde</label>
                    <input type="date" name="FechaDesde" class="form-control form-control-sm" value="@ViewBag.FechaDesde" required />
                </div>

                <div class="form-group col-md-2 mb-2">
                    <label for="fecha" class="small font-weight-bold">Fecha Hasta</label>
                    <input type="date" name="FechaHasta" class="form-control form-control-sm" value="@ViewBag.FechaHasta" required />
                </div>

                <div class="form-group col-md-2 text-right mb-2">
                    <button type="submit" class="btn btn-primary btn-sm btn-block">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>
            </form>
        </div>
    </div>
</section>

<section class="content mt-3">
    <div class="card shadow-sm">
        <div class="card-body p-2">
            <div class="table-responsive">
                <table class="table table-sm table-bordered table-hover table-striped" id="tablaRecojo" style="width:100%">
                    <thead class="table-primary text-center">
                        <tr>
                            <th>F. Recojo</th>
                            <th>Hora</th>
                            <th>Guía</th>
                            <th>Cliente</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>      
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</section>
@* @await Html.PartialAsync("_ModRecojo", new Bazsoft_ERP.Models.Recojo()) *@
<div id="contenedorModalRecojo"></div>


@section Scripts
{
    <script src="~/adminlte/plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="~/adminlte/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
    <script src="~/adminlte/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
    <script src="~/adminlte/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
    <script>
        let filaEnEdicion = null;
        function nuevoRecojo() {
            $.get('@Url.Action("RecojoAccion", "Procesos")', function (html) {
                $("#contenedorModalRecojo").html(html);
                $("#modalRecojo").modal("show");
            });

        //     $("#formRecojo")[0].reset();
        //     $("#formRecojo").attr("action", "/Procesos/Recojo"); // acción Create
        //     $("#formRecojo input[name='Id']").val(""); // limpiar Id
        //     $("#modalRecojoLabel").text("Nuevo Recojo");
        //     $("#modalRecojo").modal("show");
        }
        $(document).ready(function () {
            var paginaGuardada = parseInt(sessionStorage.getItem('paginaRecojo')) || 0;
            var pageLengthGuardado = parseInt(sessionStorage.getItem('pageLengthRecojo')) || 10;
            var tabla = $('#tablaRecojo').DataTable({
                ajax: {
                    url: '@Url.Action("ListarRecojosAjax", "Procesos")',
                    type: 'POST',
                    data: function (d) {
                        // aquí puedes pasar parámetros extra si quieres (por ej. filtros)
                        d.FechaDesde = $("input[name='FechaDesde']").val();
                        d.FechaHasta = $("input[name='FechaHasta']").val();
                    },
                    beforeSend: function () {
                        Swal.fire({
                            title: 'Cargando...',
                            html: 'Espere un momento',
                            allowOutsideClick: false,
                            didOpen: () => Swal.showLoading()
                        });
                    },
                    complete: function () {
                        Swal.close();
                    }
                },
                columns: [
                    { data: "fechaRecojo", className: "text-center" },
                    { data: "hora" },
                    { data: "guia" },
                    { data: "clientes" },
                    { data: "estadoHtml", className: "text-center", orderable: false, searchable: false },
                    { data: "acciones", className: "text-center", orderable: false, searchable: false }
                ],
                pageLength: pageLengthGuardado,
                displayStart: paginaGuardada * pageLengthGuardado,
                responsive: true,
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
                }
            });
            // Guardar estado al cambiar página o cantidad de filas
            tabla.on('page.dt', function () {
                var info = tabla.page.info();
                sessionStorage.setItem('paginaRecojo', info.page);
                sessionStorage.setItem('pageLengthRecojo', info.length);
            });

            tabla.on('length.dt', function (e, settings, len) {
                var info = tabla.page.info();
                sessionStorage.setItem('paginaRecojo', info.page);
                sessionStorage.setItem('pageLengthRecojo', info.length);
            });
            // para que al buscar con el formulario refresque la tabla
            $("form").on("submit", function (e) {
                e.preventDefault();
                $('#tablaRecojo').DataTable().ajax.reload();
            });
        });

    </script>
}